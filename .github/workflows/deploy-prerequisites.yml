name: Deploy Prerequisites to Dev Server

on:
  push:
    branches: [ main ]
    paths:
      - 'requirements.txt'
      - 'scripts/initial_setup.sh'
      - 'scripts/database_setup.sh'
      - '.github/workflows/deploy-prerequisites.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production

env:
  APP_SERVER_IP: ${{ secrets.DEV_APP_SERVER_IP }}
  APP_SERVER_USER: ${{ secrets.DEV_APP_SERVER_USER }}
  APP_SERVER_PORT: ${{ secrets.DEV_APP_SERVER_PORT }}
  SSH_PRIVATE_KEY: ${{ secrets.DEV_SSH_PRIVATE_KEY }}
  ENVIRONMENT: ${{ github.event.inputs.environment || 'development' }}

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate Configuration
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check secrets are configured
        run: |
          echo "Checking configuration..."
          [ -n "${{ env.APP_SERVER_IP }}" ] && echo "✅ APP_SERVER_IP set" || echo "❌ APP_SERVER_IP missing"
          [ -n "${{ env.APP_SERVER_USER }}" ] && echo "✅ APP_SERVER_USER set" || echo "❌ APP_SERVER_USER missing"
          [ -n "${{ env.SSH_PRIVATE_KEY }}" ] && echo "✅ SSH_PRIVATE_KEY set ($(echo -n "${{ env.SSH_PRIVATE_KEY }}" | wc -c) chars)" || echo "❌ SSH_PRIVATE_KEY missing"
          
          # If any secret is empty, fail
          if [ -z "${{ env.APP_SERVER_IP }}" ] || [ -z "${{ env.APP_SERVER_USER }}" ] || [ -z "${{ env.SSH_PRIVATE_KEY }}" ]; then
            echo "❌ Missing required secrets"
            exit 1
          fi
          echo "✅ All secrets configured"
      
      - name: Validate requirements.txt
        run: |
          if [ ! -f requirements.txt ]; then
            echo "❌ requirements.txt not found"
            exit 1
          fi
          echo "✅ requirements.txt found"
          head -20 requirements.txt

  deploy-prerequisites:
    needs: validate
    runs-on: ubuntu-latest
    name: Deploy Prerequisites
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup SSH
        env:
          SSH_KEY: ${{ secrets.DEV_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.APP_SERVER_IP }} >> ~/.ssh/known_hosts 2>/dev/null
          echo "✅ SSH configured"
      
      - name: Test SSH Connection
        run: |
          ssh -p ${{ env.APP_SERVER_PORT }} ${{ env.APP_SERVER_USER }}@${{ env.APP_SERVER_IP }} "whoami && hostname"
      
      - name: Copy requirements
        run: |
          scp -P ${{ env.APP_SERVER_PORT }} requirements.txt ${{ env.APP_SERVER_USER }}@${{ env.APP_SERVER_IP }}:~/requirements.txt
      
      - name: Install system dependencies
        run: |
          ssh -p ${{ env.APP_SERVER_PORT }} ${{ env.APP_SERVER_USER }}@${{ env.APP_SERVER_IP }} << 'SHELL_EOF'
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev libffi-dev python3-dev python3-pip git postgresql-client
          echo "✅ System dependencies installed"
          SHELL_EOF
      
      - name: Install Python packages
        run: |
          ssh -p ${{ env.APP_SERVER_PORT }} ${{ env.APP_SERVER_USER }}@${{ env.APP_SERVER_IP }} << 'SHELL_EOF'
          python3 -m pip install --upgrade pip setuptools wheel
          python3 -m pip install -r ~/requirements.txt
          echo "✅ Python packages installed"
          SHELL_EOF
