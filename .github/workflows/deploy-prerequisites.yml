name: Deploy Prerequisites to Dev Server

on:
  push:
    branches: [ main ]
    paths:
      - 'requirements.txt'
      - 'scripts/initial_setup.sh'
      - 'scripts/database_setup.sh'
      - '.github/workflows/deploy-prerequisites.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - staging
          - production

env:
  APP_SERVER_IP: ${{ secrets.DEV_APP_SERVER_IP }}
  APP_SERVER_USER: ${{ secrets.DEV_APP_SERVER_USER }}
  APP_SERVER_PORT: ${{ secrets.DEV_APP_SERVER_PORT }}
  SSH_PRIVATE_KEY: ${{ secrets.DEV_SSH_PRIVATE_KEY }}
  ENVIRONMENT: ${{ github.event.inputs.environment || 'development' }}

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate Configuration
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check secrets are configured
        run: |
          if [ -z "${{ env.APP_SERVER_IP }}" ]; then
            echo "‚ùå DEV_APP_SERVER_IP secret not configured"
            exit 1
          fi
          if [ -z "${{ env.APP_SERVER_USER }}" ]; then
            echo "‚ùå DEV_APP_SERVER_USER secret not configured"
            exit 1
          fi
          if [ -z "${{ env.SSH_PRIVATE_KEY }}" ]; then
            echo "‚ùå DEV_SSH_PRIVATE_KEY secret not configured"
            exit 1
          fi
          echo "‚úÖ All secrets configured"
      
      - name: Validate requirements.txt
        run: |
          if [ ! -f requirements.txt ]; then
            echo "‚ùå requirements.txt not found"
            exit 1
          fi
          echo "‚úÖ requirements.txt found"
          echo "Packages to install:"
          cat requirements.txt

  deploy-prerequisites:
    needs: validate
    runs-on: ubuntu-latest
    name: Deploy Prerequisites
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          printf "%s" "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.APP_SERVER_IP }} >> ~/.ssh/known_hosts 2>/dev/null
          echo "‚úÖ SSH configured"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEV_SSH_PRIVATE_KEY }}
      
      - name: Test SSH Connection
        run: |
          ssh -p ${{ env.APP_SERVER_PORT }} ${{ env.APP_SERVER_USER }}@${{ env.APP_SERVER_IP }} \
            "echo '‚úÖ SSH connection successful'; whoami; hostname"
      
      - name: Check System Requirements
        run: |
          ssh -p ${{ env.APP_SERVER_PORT }} ${{ env.APP_SERVER_USER }}@${{ env.APP_SERVER_IP }} << 'EOF'
          echo "üìä System Information:"
          echo "OS: $(uname -s)"
          echo "Kernel: $(uname -r)"
          echo "CPU Cores: $(nproc)"
          echo "Memory: $(free -h | grep Mem | awk '{print $2}')"
          echo ""
          echo "üì¶ Checking existing tools:"
          python3 --version 2>/dev/null || echo "‚ùå Python 3 not found"
          pip3 --version 2>/dev/null || echo "‚ùå pip3 not found"
          git --version 2>/dev/null || echo "‚ùå Git not found"
          docker --version 2>/dev/null || echo "‚ùå Docker not found"
          EOF
      
      - name: Create deployment directory
        run: |
          ssh -p ${{ env.APP_SERVER_PORT }} ${{ env.APP_SERVER_USER }}@${{ env.APP_SERVER_IP }} << 'EOF'
          mkdir -p ~/erp-deployment
          mkdir -p ~/erp-deployment/scripts
          mkdir -p ~/erp-deployment/logs
          echo "‚úÖ Deployment directories created"
          ls -la ~/erp-deployment/
          EOF
      
      - name: Copy project files to server
        run: |
          echo "üì§ Copying requirements.txt..."
          scp -P ${{ env.APP_SERVER_PORT }} requirements.txt \
            ${{ env.APP_SERVER_USER }}@${{ env.APP_SERVER_IP }}:~/erp-deployment/
          
          echo "üì§ Copying scripts..."
          scp -P ${{ env.APP_SERVER_PORT }} -r scripts/ \
            ${{ env.APP_SERVER_USER }}@${{ env.APP_SERVER_IP }}:~/erp-deployment/
          
          echo "üì§ Copying .env.example..."
          scp -P ${{ env.APP_SERVER_PORT }} .env.example \
            ${{ env.APP_SERVER_USER }}@${{ env.APP_SERVER_IP }}:~/erp-deployment/
          
          echo "‚úÖ Files copied successfully"
      
      - name: Install System Dependencies
        run: |
          ssh -p ${{ env.APP_SERVER_PORT }} ${{ env.APP_SERVER_USER }}@${{ env.APP_SERVER_IP }} << 'EOF'
          echo "üì¶ Installing system packages..."
          sudo -u root apt-get update -qq
          sudo -u root apt-get install -y \
            python3-pip \
            python3-venv \
            python3-dev \
            build-essential \
            libpq-dev \
            postgresql-client \
            git \
            curl \
            wget \
            nano \
            htop \
            2>&1 | grep -E "(Setting up|Processing|done)" || true
          
          echo "‚úÖ System dependencies installed"
          EOF
      
      - name: Create Python Virtual Environment
        run: |
          ssh -p ${{ env.APP_SERVER_PORT }} ${{ env.APP_SERVER_USER }}@${{ env.APP_SERVER_IP }} << 'EOF'
          echo "üêç Creating Python virtual environment..."
          cd ~/erp-deployment
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip setuptools wheel
          echo "‚úÖ Virtual environment created"
          EOF
      
      - name: Install Python Dependencies
        run: |
          ssh -p ${{ env.APP_SERVER_PORT }} ${{ env.APP_SERVER_USER }}@${{ env.APP_SERVER_IP }} << 'EOF'
          echo "üì¶ Installing Python packages..."
          cd ~/erp-deployment
          source venv/bin/activate
          pip install -q -r requirements.txt
          echo "‚úÖ Python dependencies installed"
          echo "Installed packages:"
          pip list | head -20
          EOF
      
      - name: Setup Environment Configuration
        run: |
          ssh -p ${{ env.APP_SERVER_PORT }} ${{ env.APP_SERVER_USER }}@${{ env.APP_SERVER_IP }} << 'EOF'
          echo "‚öôÔ∏è Setting up environment configuration..."
          cd ~/erp-deployment
          
          # Create .env file for development
          if [ ! -f .env ]; then
            cp .env.example .env
            sed -i 's/ENVIRONMENT=development/ENVIRONMENT=development/' .env
            sed -i 's/DEBUG=True/DEBUG=True/' .env
            sed -i 's/DB_HOST=localhost/DB_HOST=localhost/' .env
            echo "‚úÖ .env file created"
          else
            echo "‚ö†Ô∏è .env file already exists"
          fi
          
          cat .env | grep -E "^(ENVIRONMENT|DEBUG|DB_)" || true
          EOF
      
      - name: Clone/Update Repository
        run: |
          ssh -p ${{ env.APP_SERVER_PORT }} ${{ env.APP_SERVER_USER }}@${{ env.APP_SERVER_IP }} << 'EOF'
          cd ~/erp-deployment
          
          if [ -d ".git" ]; then
            echo "üì• Updating existing repository..."
            git pull origin main 2>/dev/null || echo "‚ö†Ô∏è Could not pull (might be first clone)"
          else
            echo "üì• Cloning repository..."
            git init
            git remote add origin https://github.com/tradifyglobal/Applications.git
            git fetch origin main
            git checkout -b main origin/main 2>/dev/null || echo "Repository initialized"
          fi
          
          echo "üìÇ Repository structure:"
          ls -la | head -20
          EOF
      
      - name: Verify Django Installation
        run: |
          ssh -p ${{ env.APP_SERVER_PORT }} ${{ env.APP_SERVER_USER }}@${{ env.APP_SERVER_IP }} << 'EOF'
          echo "‚úîÔ∏è Verifying Django installation..."
          cd ~/erp-deployment
          source venv/bin/activate
          
          python -c "import django; print(f'Django version: {django.VERSION}')"
          python -c "import rest_framework; print('‚úÖ Django REST Framework installed')"
          python -c "import daphne; print('‚úÖ Daphne installed')"
          python -c "import celery; print('‚úÖ Celery installed')"
          
          echo ""
          echo "Django commands available:"
          ./venv/bin/django-admin help | head -10
          EOF
      
      - name: Setup Database Connection Test
        run: |
          ssh -p ${{ env.APP_SERVER_PORT }} ${{ env.APP_SERVER_USER }}@${{ env.APP_SERVER_IP }} << 'EOF'
          echo "üóÑÔ∏è Database configuration:"
          cd ~/erp-deployment
          source venv/bin/activate
          
          # Create a test script to verify database connectivity
          cat > test_db.py << 'PYEOF'
          import os
          os.environ.setdefault('ENVIRONMENT', 'development')
          os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')
          
          import django
          django.setup()
          
          from django.db import connection
          try:
              with connection.cursor() as cursor:
                  print("‚úÖ Database connection test passed")
          except Exception as e:
              print(f"‚ö†Ô∏è Database not ready yet: {e}")
              print("Database will need to be configured separately")
          PYEOF
          
          python test_db.py 2>/dev/null || echo "‚ö†Ô∏è Database configuration pending"
          EOF
      
      - name: Create Deployment Checklist
        run: |
          ssh -p ${{ env.APP_SERVER_PORT }} ${{ env.APP_SERVER_USER }}@${{ env.APP_SERVER_IP }} << 'EOF'
          cat > ~/erp-deployment/DEPLOYMENT_CHECKLIST.md << 'MDEOF'
          # Deployment Checklist
          
          ## Prerequisites Installed ‚úÖ
          - [x] System packages
          - [x] Python 3 and pip
          - [x] Python virtual environment
          - [x] Python dependencies (from requirements.txt)
          - [x] Environment configuration (.env)
          
          ## Next Steps to Complete
          
          ### 1. Database Setup
          ```bash
          cd ~/erp-deployment
          source venv/bin/activate
          
          # Update .env with database credentials
          nano .env
          
          # Run migrations
          export ENVIRONMENT=development
          python manage.py migrate
          ```
          
          ### 2. Create Superuser
          ```bash
          python manage.py createsuperuser
          ```
          
          ### 3. Collect Static Files
          ```bash
          python manage.py collectstatic --noinput
          ```
          
          ### 4. Run Development Server
          ```bash
          python manage.py runserver 0.0.0.0:8000
          ```
          
          Or for production:
          ```bash
          gunicorn core.wsgi:application --bind 0.0.0.0:8000
          ```
          
          ### 5. Run Tests
          ```bash
          pytest apps/ -v
          ```
          
          ## Server Information
          - App Server: ${{ env.APP_SERVER_IP }}
          - Deployment Path: ~/erp-deployment
          - Environment: ${{ env.ENVIRONMENT }}
          
          ## Useful Commands
          
          ### Activate Virtual Environment
          ```bash
          cd ~/erp-deployment
          source venv/bin/activate
          ```
          
          ### Check Installed Packages
          ```bash
          pip list
          ```
          
          ### View Logs
          ```bash
          tail -f ~/erp-deployment/logs/erp.log
          ```
          
          ## Troubleshooting
          
          If database connection fails:
          1. Ensure PostgreSQL is running
          2. Check database credentials in .env
          3. Test connection: `psql -U user -d database -h host`
          
          If static files are missing:
          ```bash
          python manage.py collectstatic --noinput
          ```
          
          If migrations fail:
          ```bash
          python manage.py migrate --fake-initial
          ```
          MDEOF
          
          cat ~/erp-deployment/DEPLOYMENT_CHECKLIST.md
          EOF
      
      - name: Generate Deployment Summary
        run: |
          ssh -p ${{ env.APP_SERVER_PORT }} ${{ env.APP_SERVER_USER }}@${{ env.APP_SERVER_IP }} << 'EOF'
          cat > ~/erp-deployment/DEPLOYMENT_SUMMARY.txt << 'TXTEOF'
          ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
          ‚ïë       ERP APPLICATION PREREQUISITES DEPLOYED             ‚ïë
          ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
          
          üìÖ Deployment Date: $(date)
          üñ•Ô∏è  Server: ${{ env.APP_SERVER_IP }}
          üë§ User: ${{ env.APP_SERVER_USER }}
          üìÅ Deployment Path: ~/erp-deployment
          üåç Environment: ${{ env.ENVIRONMENT }}
          
          ‚úÖ INSTALLED COMPONENTS:
          ‚úì System dependencies
          ‚úì Python 3.x and pip
          ‚úì Python virtual environment
          ‚úì Django 4.2.7
          ‚úì Django REST Framework
          ‚úì Database drivers (psycopg2)
          ‚úì All dependencies from requirements.txt
          
          üì¶ PYTHON ENVIRONMENT:
          Location: ~/erp-deployment/venv
          Activate: source ~/erp-deployment/venv/bin/activate
          
          üîß CONFIGURATION FILES:
          .env: ~/erp-deployment/.env
          
          üìÇ DIRECTORY STRUCTURE:
          ~/erp-deployment/
          ‚îú‚îÄ‚îÄ venv/                 # Python virtual environment
          ‚îú‚îÄ‚îÄ scripts/              # Deployment scripts
          ‚îú‚îÄ‚îÄ requirements.txt      # Python dependencies
          ‚îú‚îÄ‚îÄ .env                  # Environment configuration
          ‚îî‚îÄ‚îÄ logs/                 # Application logs
          
          üéØ NEXT STEPS:
          1. SSH into the server:
             ssh -p ${{ env.APP_SERVER_PORT }} ${{ env.APP_SERVER_USER }}@${{ env.APP_SERVER_IP }}
          
          2. Navigate to deployment directory:
             cd ~/erp-deployment
          
          3. Activate virtual environment:
             source venv/bin/activate
          
          4. Update database configuration in .env
          
          5. Run migrations:
             python manage.py migrate
          
          6. Create superuser:
             python manage.py createsuperuser
          
          7. Test the application:
             python manage.py runserver 0.0.0.0:8000
          
          üìñ DOCUMENTATION:
          - Environment Setup: ENVIRONMENTS.md
          - Deployment Guide: docs/DEPLOYMENT_GUIDE.md
          - Checklist: DEPLOYMENT_CHECKLIST.md
          
          ‚ùì SUPPORT:
          For issues, check the logs:
          tail -f ~/erp-deployment/logs/erp.log
          
          ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
          TXTEOF
          
          cat ~/erp-deployment/DEPLOYMENT_SUMMARY.txt
          EOF
      
      - name: Success Notification
        if: success()
        run: |
          echo "‚úÖ Prerequisites deployment completed successfully!"
          echo ""
          echo "üìç Server: ${{ env.APP_SERVER_IP }}"
          echo "üë§ User: ${{ env.APP_SERVER_USER }}"
          echo "üìÅ Path: ~/erp-deployment"
          echo ""
          echo "Next steps:"
          echo "1. SSH into the server"
          echo "2. Navigate to ~/erp-deployment"
          echo "3. Source the virtual environment: source venv/bin/activate"
          echo "4. Configure .env with database credentials"
          echo "5. Run: python manage.py migrate"
          echo "6. Run: python manage.py createsuperuser"

  notify:
    needs: deploy-prerequisites
    runs-on: ubuntu-latest
    if: always()
    name: Send Notification
    
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Prerequisites deployment completed successfully"
          else
            echo "‚ùå Prerequisites deployment failed"
          fi
